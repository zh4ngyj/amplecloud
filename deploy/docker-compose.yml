version: "3.9"

x-otel-env: &otel-env
  OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
  OTEL_ENVIRONMENT: dev
  OTEL_EXPORTER_OTLP_PROTOCOL: grpc

x-common-env: &default-service-env
  <<: *otel-env
  EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/

services:
  jaeger:
    image: jaegertracing/all-in-one:1.59
    container_name: jaeger
    ports:
      - "16686:16686" # Jaeger UI
      - "14268:14268" # Jaeger Collector HTTP
      - "14250:14250" # gRPC
    environment:
      - COLLECTOR_ZIPKIN_HTTP_PORT=9411
    networks:
      - microservices

  otel-collector:
    image: otel/opentelemetry-collector:0.104.0
    container_name: otel-collector
    command:
      - "--config=/etc/otel-collector-config.yaml"
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml:ro
    ports:
      - "4317:4317"
      - "4318:4318"
    depends_on:
      - jaeger
    networks:
      - microservices

  eureka-server:
    build:
      context: ..
      dockerfile: deploy/docker/Dockerfile.service
      args:
        VERSION: ${SERVICE_VERSION:-0.1}
        SERVICE: eureka-server
    image: agent-hystrix/eureka-server:${SERVICE_VERSION:-0.1}
    container_name: eureka-server
    ports:
      - "8761:8761"
    environment:
      <<: *otel-env
    depends_on:
      - otel-collector
    networks:
      - microservices
    restart: unless-stopped

  product-service:
    build:
      context: ..
      dockerfile: deploy/docker/Dockerfile.service
      args:
        VERSION: ${SERVICE_VERSION:-0.1}
        SERVICE: product-service
    image: agent-hystrix/product-service:${SERVICE_VERSION:-0.1}
    container_name: product-service
    ports:
      - "8081:8081"
    environment:
      <<: *default-service-env
    depends_on:
      - eureka-server
      - otel-collector
    networks:
      - microservices
    restart: unless-stopped

  order-service:
    build:
      context: ..
      dockerfile: deploy/docker/Dockerfile.service
      args:
        VERSION: ${SERVICE_VERSION:-0.1}
        SERVICE: order-service
    image: agent-hystrix/order-service:${SERVICE_VERSION:-0.1}
    container_name: order-service
    ports:
      - "8082:8082"
    environment:
      <<: *default-service-env
    depends_on:
      - eureka-server
      - otel-collector
    networks:
      - microservices
    restart: unless-stopped

  api-gateway:
    build:
      context: ..
      dockerfile: deploy/docker/Dockerfile.service
      args:
        VERSION: ${SERVICE_VERSION:-0.1}
        SERVICE: api-gateway
    image: agent-hystrix/api-gateway:${SERVICE_VERSION:-0.1}
    container_name: api-gateway
    ports:
      - "8080:8080"
    environment:
      <<: *default-service-env
    depends_on:
      - eureka-server
      - product-service
      - order-service
      - otel-collector
    networks:
      - microservices
    restart: unless-stopped

networks:
  microservices:
    driver: bridge
